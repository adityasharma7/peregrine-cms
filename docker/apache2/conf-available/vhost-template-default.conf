<Macro VhostTemplateDefault $host $peregrinesite>
<VirtualHost *:80>

    Protocols h2 http/1.1

    ModPagespeed unplugged
    ModPagespeedEnableCachePurge on
    ModPagespeedPurgeMethod PURGE

    SetOutputFilter DEFLATE
    ExpiresActive   On
    ExpiresByType   image/jpeg "access plus 1 year"
    ExpiresByType   image/png "access plus 1 year"
    ExpiresDefault  "access plus 1 month"

    ServerAdmin webmaster@$host
    DocumentRoot "/app/sling/staticreplication"
    ServerName $host
    ErrorLog "${APACHE_LOG_DIR}/$host-error_log"
    CustomLog "${APACHE_LOG_DIR}/$host-access_log" common

    <Directory /app/sling/staticreplication>
        Options Indexes FollowSymLinks
        AllowOverride None
        Require all granted
    </Directory>

    ErrorDocument 404 /content/$peregrinesite/pages/errors/404.html

    RewriteEngine On

    # Block URIs
    RewriteCond %{REQUEST_URI} ^(/bin|/system).*$ [NC,OR]
    RewriteCond %{REQUEST_URI} ^(/perapi/admin|/content/admin).*$ [NC]
    RewriteRule ^ - [R=404,NC,L]

    # Prevent HTTP methods that change the state of the server
    RewriteCond %{REQUEST_METHOD} ^(DELETE|POST|PUT)$ [NC]
    RewriteRule ^ - [R=403,NC,L]

    # Add support for robots.txt at root of site
    RewriteRule "robots.txt$" /content/$peregrinesite/pages/robots.txt [PT]

    # Redirect to home page
    RewriteRule "^/$" /content/$peregrinesite/pages/index.html [PT,L]
    RewriteRule "^/content/$peregrinesite$" /content/$peregrinesite/pages/index.html [PT,L]

    # Handle short URLs
    RewriteCond %{REQUEST_URI} !/content/.*
    RewriteRule "^(.*)\.html$" /content/$peregrinesite/pages$1.html [PT]

    # Handle sitemap
    RewriteRule ^/sitemap.xml$ /content/$peregrinesite/pages.sitemap.xml [PT,L]

    # Handle serviceworker
    RewriteRule ^/serviceworker.js$ /content/$peregrinesite/pages/serviceworker.js [PT,L]

</VirtualHost>
</Macro>
